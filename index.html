<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/css/css.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            width: 100%;
            height: 100%;
            background: #eee;
            display: flex;
            align-items: center;
            flex-direction: column;
            gap: 10px;
        }
        .code-box {
            width: 100%;
            height: 200px  !important;
            background: #fff;
            border-radius: 0;
            border-bottom: 2px solid #0ff;
            direction: ltr;
            position: relative;
        }
        .code-header {
            width: 100%;
            height: 50px;
            background: #eff;
            padding: 10px;
            border-radius: 0;
            border-bottom: 1px solid #0bb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }
        .header-box {
            width: auto;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            gap: 5px;
        }
        .run-code,
        .view-code,
        .add-file,
        .open-files,
        .title {
            min-width: 30px;
            width: auto;
            height: 30px;
            background: #0ff;
            padding: 10px;
            border-radius: 5px;
            border: none;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            gap: 5px;
        }
        .open-files {
            width: 100px;
        }
        .files {
            width: 200px;
            max-height: 100px;
            background: #eff;
            border-radius: 5px;
            position: absolute;
            top: 50px;
            right: 10px;
            z-index: 10;
            overflow-y: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
        }
        .files.active {
            display: block;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #aaa;
            cursor: pointer;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-item:hover {
            background: #dff;
        }
        .file-item.active {
            background: #bff;
        }
        .file-info {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
        }
        .file-actions {
            position: relative;
        }
        .file-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: #eff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 20;
            display: none;
            min-width: 120px;
        }
        .file-menu.active {
            display: block;
        }
        .menu-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        .menu-item:hover {
            background: #dff;
        }
        .code,
        .output {
            width: 100%;
            height: calc(100% - 50px);
            background: #fff !important;
            border-radius: 0;
            border: none;
        }
        .CodeMirror {
            width: 100% !important;
            height: 100% !important;
            background: #fff !important;
            border-radius: 0;
            font-size: 10px !important;
            font-family: Consolas, Monaco, "Andale Mono", monospace;
            text-align: left;
            direction: ltr;
            line-height: 1.5;
            letter-spacing: 1.5;
            word-spacing: 1.5;
            resize: none;
            white-space: pre;
            overflow: auto;
        }
        .CodeMirror-gutters {
            background: #eff;
            border-right: 1px solid #0bb;
            padding: 5px;
        }
        .CodeMirror-linenumber {
            color: #000;
            font-size: 10px;
            font-weight: bold;
        }
        .iframe {
            width: 100% !important;
            height: 100% !important;
            background: #fff;
            border-radius: 0;
            border: none;
        }
        .file-name-input {
            background: transparent;
            border: none;
            outline: none;
            font-size: 12px;
            width: 100%;
        }
        
        
        .container {
            width: 100%;
            height: 100%;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            flex-direction: column;
            overflow: hidden;
        }
        .header {
            width: 100%;
            height: 80px;
            background: #eff;
            padding: 10px;
            border-bottom: 2px solid #0ff;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .profile {
            width: auto;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            gap: 10px;
        }
        .heart {
            width: 50px;
            height: 50px;
            border: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="red"><path d="M12 21s-6.2-4.3-9.4-7.5C.5 11.4.5 7.2 3.1 4.6 5.7 2 9.9 2 12 4.1 14.1 2 18.3 2 20.9 4.6c2.6 2.6 2.6 6.8.5 8.9C18.2 16.7 12 21 12 21z"/></svg>') no-repeat center/contain;
        }
        .head {
        	width: 100%;
            height: 30px;
            background: #fef;
            padding: 5px;
            border-bottom: 2px solid #f0f;
            font-size: 15px;
            font-weight: bold;
        }
        .chati {
        	width: 20px;
            height: 20px;
            border: none;
        	background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>') no-repeat center/contain;
        }
        .codei {
        	width: 20px;
            height: 20px;
            border: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="m14.6 16.6 4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4zm-5.2 0L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4z"/></svg>') no-repeat center/contain;
        }
        .main-title {
            font-size: 15px;
        }
        .close-chat {
            width: 40px;
            height: 40px;
            background: #fee;
            border-radius: 10px;
            border: 2px solid #f00;
            font-size: 15px;
        }
        .chat-messages {
            width: 100%;
            height: calc(100% - 310px) !important;
            padding: 10px;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }
        .message-box {
            width: auto;
            height: auto;
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            text-align: center;
            gap: 5px;
            position: relative;
        }
        .user-profile {
            width: 40px;
            height: 40px;
            background: #000;
            border-radius: 10px 10px 0 10px;
            border: 2px solid #0ff;
            margin-top: auto;
            position: sticky;
            bottom: 0;
        }
        .message {
            min-width: 150px;
            width: auto;
            max-width: 250px;
            min-height: 50px;
            height: auto;
            background: #fff;
            color: #000;
            padding: 10px;
            border: 2px solid #000;
            font-size: 15px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            text-align: right;
            flex-direction: column;
            line-height: normal;
            direction: rtl;
            transition: all 0.3s ease;
        }
        .username {
            width: auto;
            height: auto;
            background: transparent;
            color: #0aa;
            font-size: 10px;
            font-weight: bold;
            text-align: left;
            margin-right: auto;
            margin-bottom: 10px;
        }
        .message-content {
            width: 100%;
            background: transparent;
            font-family: 'Vazirmatn', sans-serif;
            white-space: pre-wrap;
            word-break: break-word;
            text-align: right;
            direction: rtl;
            margin-left: auto;
        }
        .reply-message,
        .delete-message {
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 5px;
            border: 1px solid #000;
            font-size: 5px;
        }
        .delete-message {
            background: #f00;
        }
        .my-message-box {
            margin-left: auto;
        }
        .other-message-box {
            margin-right: auto;
        }
        .my-message {
            background: #eff;
            border-radius: 10px 10px 0 10px;
            border: 2px solid #0ff;
        }
        .other-message {
            background: #fef;
            border-radius: 10px 10px 10px 0;
            border: 2px solid #f0f;
        }
        .reply-box {
            width: 100%;
            height: 60px;
            background: #fef;
            padding: 10px;
            border-top: 2px solid #f0f;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .reply-icon {
            font-size: 15px;
        }
        .reply-content {
            width: calc(100% - 80px);
            height: 100%;
            background: #fcf;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #a0a;
            font-size: 10px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            gap: 10px;
            margin-left: auto;
            white-space: nowrap;
        }
        .reply-to {
            display: flex;
            text-align: right;
            gap: 3px;
            font-size: 10px;
        }
        .reply-username {
            font-weight: bold;
        }
        .reply-preview {
            width: auto;
            max-width: 50%;
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .cancel-reply {
            width: 40px;
            height: 40px;
            background: #fee;
            border-radius: 10px;
            border: 2px solid #f00;
            font-size: 15px;
        }
        .message-replied {
            border: 2px solid #000;
        }
        .replied-message {
            width: 100%;
            height: auto;
            background: #fff;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #000;
            margin-bottom: 10px;
        }
        .username-replied {
            width: auto;
            height: auto;
            background: transparent;
            font-size: 5px;
            font-weight: bold;
        }
        .replied-text {
            font-size: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .my-replied-message {
            background: #cff;
            border: 1px solid #0aa;
        }
        .other-replied-message {
            background: #fcf;
            border: 1px solid #a0a;
        }
        .my-username-replied {
            color: #0aa;
        }
        .other-username-replied {
            color: #a0a;
        }
        .chat-input {
            width: 100%;
            height: 60px;
            background: #eff;
            padding: 10px;
            border-top: 2px solid #0ff;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            text-align: center;
            direction: ltr;
            gap: 10px;
        }
        .message-input {
            width: calc(100% - 50px);
            height: 40px;
            padding: 5px;
            border-radius: 10px;
            border: 1px solid #000;
            font-family: inherit;
            text-align: right;
            direction: rtl;
            line-height: normal;
            letter-spacing: normal;
            word-spacing: normal;
            white-space: pre-wrap;
            resize: none;
            outline: none;
            overflow-y: auto;
        }
        .send-message {
            width: 40px;
            height: 40px;
            background: #0ff;
            border-radius: 10px;
            border: 2px solid #000;
            font-size: 15px;
        }
        /* استایل بلوک کد */
        .code-block {
            width: 100%;
            max-width: 100%;
            height: auto;
            background: #eee;
            border-radius: 5px;
            border: 1px solid #000;
            font-family: sans-serif;
            text-align: left;
            direction: ltr;
            position: relative;
            margin: 10px auto;
        }
        .copy-code {
        	width: auto;
            height: auto;
            background: #ddd;
            padding: 5px;
            border-radius: 3px;
            border: none;
            font-size: 5px;
            font-weight: bold;
            position: sticky;
            top: 5px;
            margin: 5px 0 5px 5px;
        }
        .language {
        	width: auto;
            height: auto;
            background: #ddd;
            color: #444;
            padding: 5px;
            border-radius: 3px;
            border: none;
            font-size: 5px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .codes {
        	width: 100%;
            max-width: 100%;
            height: auto;
            background: #eee !important;
            padding: 5px !important;
            border-radius: 5px !important;
            margin: 0 !important;
            font-size: 5px !important;
            font-family: Consolas, Monaco, "Andale Mono", monospace !important;
            text-align: left;
            direction: ltr;
            line-height: normal;
            letter-spacing: normal;
            word-spacing: normal;
            white-space: pre !important;
            overflow-x: auto !important;
            resize: none;
        }
        strong {
            font-weight: bold;
        }        
        .little-code {
        	background: #ccc;
            font-family: Consolas, Monaco, "Andale Mono", monospace !important;
            padding: 2px;
            border-radius: 3px;
            border: 0.5px solid #000;
            display: flex;
            text-align: left;
            direction: ltr;
        }
        blockquote {
        	width: 100%;
            height: auto;
        	background: transparent;
            padding: 5px;
            font-weight: bold;
            font-style: italic;
            border-radius: 5px;
            border: none;
            border-right: 3px solid #000;
            margin: 5px auto;
        }
        em {
        	font-style: italic;
            transform: skewX(-10deg);
            display: inline-block;
        }
        button {
            transition: all 0.3s ease;
        }
        button:active {
            transform: scale(0.8);
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    
    <div class="container">
        <div class="header">
            <div class="profile">
                <div class="heart"></div>
                <div class="main-title">He & He Team</div>
                <div class="heart"></div>
            </div>
        </div>
        
        <div class="head">
            <div class="profile">
                <div class="codei"></div>
                <div class="main-title">Code</div>
                <div class="codei"></div>
            </div>
        </div>
        
        <div class="code-box" id="code-box">
        <div class="code-header">
            <div class="header-box">
                <button class="run-code" id="run-code">
                    <span>Run Code</span>
                    <i class="fas fa-play"></i>
                </button>
                <button class="view-code hidden" id="view-code">
                    <span>View Code</span>
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div class="header-box">
                <button class="add-file" id="add-file">
                    <i class="fas fa-file-circle-plus"></i>
                </button>
                <button class="open-files" id="open-files">
                    <i class="fas fa-chevron-down"></i>
                    <div class="file-name" id="file-name">file.html</div>
                </button>
                <div class="title hidden" id="title">WebPage</div>
            </div>
        </div>
        <div class="files" id="files">
            <!-- فایل‌ها در اینجا نمایش داده می‌شوند -->
        </div>
        <div class="code" id="code">
            <textarea class="editor-full" id="editor-full"></textarea>
        </div>
        <div class="output hidden" id="output">
            <iframe class="iframe" id="iframe"></iframe>
        </div>
    </div>
    
        <div class="head">
            <div class="profile">
                <div class="chati"></div>
                <div class="main-title">Caht</div>
                <div class="chati"></div>
            </div>
        </div>

        <div class="chat-messages" id="messages"></div>

        <div id="reply-preview" class="reply-box hidden">
            <i class="fas fa-reply reply-icon"></i>
            <div class="reply-content">
                <div class="reply-to">
                    <div>پاسخ به پیام</div>
                    <span class="reply-username"></span>
                    <div>:</div>
                </div>
                <div class="reply-preview"></div>
            </div>
            <button class="cancel-reply">
                <i class="fas fa-close"></i>
            </button>
        </div>

        <div class="chat-input">
            <textarea class="message-input" id="message-input" placeholder="پیام خود را بنویسید..." maxlength="10000"></textarea>
            <button class="send-message" id="send-button">
                <i class="fas fa-arrow-up"></i>
            </button>
        </div>
    </div>

    <script>
        // مدیریت فایل‌ها
        let files = [
            { id: 0, name: 'file.html', content: document.getElementById('editor-full').value, active: true }
        ];
        let activeFileId = 1;
        let fileCounter = 0;

        // CodeMirror Editor
        const editorFull = CodeMirror.fromTextArea(document.getElementById("editor-full"), {
            mode: "htmlmixed",
            theme: "default",
            lineNumbers: true
        });
        
        editorFull.setValue('<!DOCTYPE html>\n<html>\n<head>\n\t<title>New File</title>\n</head>\n<body>\n\t<h1>New File</h1>\n</body>\n</html>');

        // عناصر DOM
        const runCode = document.getElementById('run-code');
        const viewCode = document.getElementById('view-code');
        const code = document.getElementById('code');
        const output = document.getElementById('output');
        const openFiles = document.getElementById('open-files');
        const title = document.getElementById('title');
        const iframe = document.getElementById('iframe');
        const filesContainer = document.getElementById('files');
        const fileName = document.getElementById('file-name');
        const addFile = document.getElementById('add-file');

        // نمایش فایل‌ها
        function renderFiles() {
            filesContainer.innerHTML = '';
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${file.active ? 'active' : ''}`;
                fileItem.dataset.id = file.id;
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <i class="fas fa-file-code"></i>
                        <span class="file-name-text">${file.name}</span>
                    </div>
                    <div class="file-actions">
                        <i class="fas fa-ellipsis-v"></i>
                        <div class="file-menu">
                            <div class="menu-item rename-file">
                                <i class="fas fa-edit"></i>
                                <span>تغییر نام</span>
                            </div>
                            <div class="menu-item delete-file">
                                <i class="fas fa-trash"></i>
                                <span>حذف</span>
                            </div>
                        </div>
                    </div>
                `;
                
                filesContainer.appendChild(fileItem);
                
                // رویداد کلیک روی فایل
                fileItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.file-actions')) {
                        switchFile(file.id);
                    }
                });
                
                // رویداد کلیک روی سه نقطه
                const fileActions = fileItem.querySelector('.file-actions');
                const fileMenu = fileItem.querySelector('.file-menu');
                const ellipsis = fileItem.querySelector('.fa-ellipsis-v');
                
                ellipsis.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // بستن همه منوهای باز
                    document.querySelectorAll('.file-menu').forEach(menu => {
                        menu.classList.remove('active');
                    });
                    fileMenu.classList.toggle('active');
                });
                
                // رویداد تغییر نام
                const renameBtn = fileItem.querySelector('.rename-file');
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    renameFile(file.id);
                    fileMenu.classList.remove('active');
                });
                
                // رویداد حذف
                const deleteBtn = fileItem.querySelector('.delete-file');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteFile(file.id);
                    fileMenu.classList.remove('active');
                });
            });
        }

        // تغییر فایل فعال
        function switchFile(fileId) {
            // ذخیره محتوای فایل فعلی
            const currentFile = files.find(f => f.id === activeFileId);
            if (currentFile) {
                currentFile.content = editorFull.getValue();
            }
            
            // تغییر فایل فعال
            files.forEach(file => {
                file.active = file.id === fileId;
            });
            
            activeFileId = fileId;
            
            // به‌روزرسانی ویرایشگر با محتوای فایل جدید
            const newFile = files.find(f => f.id === fileId);
            editorFull.setValue(newFile.content);
            
            // به‌روزرسانی نمایش
            fileName.textContent = newFile.name;
            renderFiles();
            hideFiles();
        }

        // افزودن فایل جدید
        function addNewFile() {
            fileCounter++;
            const newFile = {
                id: fileCounter,
                name: `file${fileCounter}.html`,
                content: '<!DOCTYPE html>\n<html>\n<head>\n\t<title>New File</title>\n</head>\n<body>\n\t<h1>New File</h1>\n</body>\n</html>',
                active: false
            };
            
            files.push(newFile);
            switchFile(newFile.id);
        }

        // تغییر نام فایل
        function renameFile(fileId) {
            const fileItem = document.querySelector(`.file-item[data-id="${fileId}"]`);
            const fileNameText = fileItem.querySelector('.file-name-text');
            const currentName = fileNameText.textContent;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'file-name-input';
            
            fileNameText.replaceWith(input);
            input.focus();
            input.select();
            
            function saveName() {
                const newName = input.value.trim();
                if (newName && newName !== currentName) {
                    const file = files.find(f => f.id === fileId);
                    file.name = newName;
                    
                    if (file.active) {
                        fileName.textContent = newName;
                    }
                }
                
                const newSpan = document.createElement('span');
                newSpan.className = 'file-name-text';
                newSpan.textContent = file.name;
                input.replaceWith(newSpan);
                
                renderFiles();
            }
            
            input.addEventListener('blur', saveName);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveName();
                } else if (e.key === 'Escape') {
                    const newSpan = document.createElement('span');
                    newSpan.className = 'file-name-text';
                    newSpan.textContent = currentName;
                    input.replaceWith(newSpan);
                    renderFiles();
                }
            });
        }

        // حذف فایل
        function deleteFile(fileId) {
            if (files.length <= 1) {
                alert('حداقل یک فایل باید وجود داشته باشد');
                return;
            }
            
            const fileIndex = files.findIndex(f => f.id === fileId);
            const isActive = files[fileIndex].active;
            
            files.splice(fileIndex, 1);
            
            if (isActive) {
                // اگر فایل فعال حذف شد، اولین فایل را فعال کنید
                switchFile(files[0].id);
            } else {
                renderFiles();
            }
        }

        // نمایش/پنهان کردن لیست فایل‌ها
        function toggleFiles() {
            filesContainer.classList.toggle('active');
        }

        // پنهان کردن لیست فایل‌ها
        function hideFiles() {
            filesContainer.classList.remove('active');
        }

        // اجرای کد
        runCode.addEventListener('click', () => {
            const activeFile = files.find(f => f.id === activeFileId);
            activeFile.content = editorFull.getValue();
            
            const codeContent = activeFile.content;
            const titleMatch = codeContent.match(/<title>(.*?)<\/title>/i);
            title.textContent = titleMatch ? titleMatch[1] : "WebPage";
            iframe.srcdoc = codeContent;

            runCode.classList.add('hidden');
            addFile.classList.add('hidden');
            openFiles.classList.add('hidden');
            code.classList.add('hidden');
            viewCode.classList.remove('hidden');
            title.classList.remove('hidden');
            output.classList.remove('hidden');
            hideFiles();
        });

        // مشاهده کد
        viewCode.addEventListener('click', () => {
            runCode.classList.remove('hidden');
            addFile.classList.remove('hidden');
            openFiles.classList.remove('hidden');
            code.classList.remove('hidden');
            viewCode.classList.add('hidden');
            title.classList.add('hidden');
            output.classList.add('hidden');
            hideFiles();
        });

        // رویدادهای کلیک
        openFiles.addEventListener('click', toggleFiles);
        addFile.addEventListener('click', addNewFile);

        // بستن لیست فایل‌ها با کلیک در جای دیگر
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.files') && !e.target.closest('.open-files')) {
                hideFiles();
            }
        });

        // مقداردهی اولیه
        renderFiles();
    </script>

    <script>
        const currentUser = {
            id: 'helia',
            username: 'helia',
            isAdmin: false // تغییر بده به true برای تست حذف پیام
        };

        const messages = [];
        let replyTo = null;

        const messagesEl = document.getElementById('messages');
        const input = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const replyPreview = document.getElementById('reply-preview');
        const replyPreviewContent = replyPreview.querySelector('.reply-preview');
        const replyPreviewUsername = replyPreview.querySelector('.reply-username');
        const cancelReplyBtn = replyPreview.querySelector('.cancel-reply');

        function generateId() {
            return 'msg-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
        }
        
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function formatMessage(text) {
    if (!text) return '';

    const escaped = escapeHtml(text);

    // پردازش بلوک‌های کد با createElement
    const withCodeBlocks = escaped.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang = 'text', code) => {
        const safeCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        const codeBox = document.createElement('div');
        codeBox.className = 'code-box';

        const languageLabel = document.createElement('div');
        languageLabel.className = 'language';
        languageLabel.textContent = lang;

        const copyButton = document.createElement('button');
        copyButton.className = 'copy-code';
        copyButton.textContent = 'Copy';

        const preElement = document.createElement('pre');
        preElement.className = `code language-${lang}`;

        const codeElement = document.createElement('code');
        codeElement.className = `language-${lang}`;
        codeElement.innerHTML = safeCode; // استفاده از innerHTML چون قبلا escape شده

        preElement.appendChild(codeElement);
        codeBox.append(languageLabel, copyButton, preElement);

        // تبدیل DOM به رشته HTML برای سازگاری با باقی تابع
        return codeBox.outerHTML;
    });

    // پردازش سایر فرمت‌ها
    return withCodeBlocks
        .replace(/\((.*?)\)\[(https?:\/\/.*?)\]/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/##(.*?)##/g, '<em>$1</em>')
        .replace(/__(.*?)__/g, '<u>$1</u>')
        .replace(/--(.*?)--/g, '<s>$1</s>')
        .replace(/~~(.*?)~~/g, '<blockquote>$1</blockquote>')
        .replace(/``(.*?)``/g, '<code class="little-code">$1</code>');
}

        function renderMessages() {
            messagesEl.innerHTML = '';
            messages.forEach(msg => {
                const isMyMessage = msg.userId === currentUser.id;
                const messageBox = document.createElement('div');
                messageBox.className = `message-box ${isMyMessage ? 'my-message-box' : 'other-message-box'}`;
                messageBox.dataset.id = msg.id;

                // دکمه‌های ریپلای و حذف
                const replyBtn = document.createElement('button');
                replyBtn.className = 'reply-message hidden';
                replyBtn.innerHTML = '<i class="fas fa-reply"></i>';
                replyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    replyTo = msg.id;
let previewText = msg.text.trim();
const codeMatch = previewText.match(/```(?:\w+)?\n([\s\S]*?)```/);
if (codeMatch) {
    const codeText = codeMatch[1].trim();
    replyPreviewContent.textContent = codeText;
} else {
    replyPreviewContent.innerHTML = DOMPurify.sanitize(formatMessage(previewText));
}
                    replyPreviewUsername.textContent = msg.username;
                    if (msg.username === currentUser.username) {
                    	replyPreviewUsername.textContent = 'شما';
                    }
                    replyPreview.classList.remove('hidden');
                    messagesEl.style.height = 'calc(100% - 200px)';
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-message hidden';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteMessage(msg.id);
                });

                // پیام اصلی
                const message = document.createElement('div');
                message.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;

// اگر پیام ریپلای دارد
                if (msg.replyTo) {
                    const original = messages.find(m => m.id === msg.replyTo);
    
    // اگر پیام اصلی پیدا نشد (حذف شده)، ریپلای را نمایش نده
                    if (!original) return;

                    const repliedMessage = document.createElement('div');
                    repliedMessage.className = `replied-message ${isMyMessage ? 'my-replied-message' : 'other-replied-message'}`;

                    const repliedUsername = document.createElement('div');
                    repliedUsername.className = `username-replied ${isMyMessage ? 'my-username-replied' : 'other-username-replied'}`;
                    repliedUsername.textContent = original.username;
                    
                    if (original.username === currentUser.username) {
                    	repliedUsername.textContent = 'شما';
                    }

                    const repliedText = document.createElement('div');
                    repliedText.className = 'replied-text';
                    repliedText.textContent = DOMPurify.sanitize(original.text);

                    repliedMessage.appendChild(repliedUsername);
                    repliedMessage.appendChild(repliedText);
                    repliedMessage.addEventListener('click', (e) => {
                        e.stopPropagation();
                        highlightMessage(msg.replyTo);
                    });

                    message.appendChild(repliedMessage);
                }

                // محتوای پیام

                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.innerHTML = DOMPurify.sanitize(formatMessage(msg.text));
                message.appendChild(messageContent);

                // اضافه کردن المان‌ها به پیام
                if (isMyMessage) {
                    messageBox.appendChild(message);
                    if (currentUser.isAdmin) messageBox.appendChild(deleteBtn);
                    messageBox.appendChild(replyBtn);
                } else {
                    messageBox.appendChild(replyBtn);
                    if (currentUser.isAdmin) messageBox.appendChild(deleteBtn);
                    messageBox.appendChild(message);
                }

                // کلیک روی پیام برای نمایش دکمه‌ها
                message.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.reply-message, .delete-message').forEach(el => el.classList.add('hidden'));
                    replyBtn.classList.remove('hidden');
                    if (currentUser.isAdmin) deleteBtn.classList.remove('hidden');
                });

                messagesEl.appendChild(messageBox);
            });
            
            messagesEl.scrollTop = messagesEl.scrollHeight;
            
document.querySelectorAll('pre code').forEach(block => {
    Prism.highlightElement(block);
});

document.querySelectorAll('.copy-code').forEach(btn => {
    btn.addEventListener('click', () => {
        const code = btn.parentElement.querySelector('code').textContent;
        navigator.clipboard.writeText(code).then(() => {
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 1000);
        });
    });
});

        }

        function deleteMessage(id) {
            const index = messages.findIndex(m => m.id === id);
            if (index !== -1) {
                messages.splice(index, 1);
                messages.forEach(m => {
                    if (m.replyTo === id) m.replyTo = null;
                });
                if (replyTo === id) {
                    replyTo = null;
                    replyPreview.classList.add('hidden');
                    messagesEl.style.height = 'calc(100% - 140px)';
                }
                renderMessages();
            }
        }

        function highlightMessage(id) {
            const msgEl = document.querySelector(`[data-id="${id}"] .message`);
            if (!msgEl) return;
            msgEl.classList.add('message-replied');
            msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => msgEl.classList.remove('message-replied'), 1000);
        }

        sendButton.addEventListener('click', () => {
            const text = input.value.trim();
            if (!text) return;
            
            messages.push({
                id: generateId(),
                userId: currentUser.id,
                username: currentUser.username,
                text,
                replyTo
            });
            
            input.value = '';
            replyTo = null;
            replyPreview.classList.add('hidden');
            messagesEl.style.height = 'calc(100% - 140px)';
            renderMessages();
        });

        // ریپلای کردن به پیام
        replyPreview.querySelector('.reply-content').addEventListener('click', () => {
            if (replyTo) highlightMessage(replyTo);
        });

        cancelReplyBtn.addEventListener('click', () => {
            replyTo = null;
            replyPreview.classList.add('hidden');
            messagesEl.style.height = 'calc(100% - 140px)';
        });

        document.addEventListener('click', () => {
            document.querySelectorAll('.reply-message, .delete-message').forEach(el => el.classList.add('hidden'));
        });

        setTimeout(() => {
            messages.push({
                id: generateId(),
                userId: currentUser.id,
                username: currentUser.username,
                text: 'سلام پروژه چطور پیش میره؟',
                replyTo: null
            });
            renderMessages();
        }, 1000);
        
        setTimeout(() => {
            messages.push({
                id: generateId(),
                userId: 'hesam',
                username: 'hesam',
                text: 'سلام، عالی!',
                replyTo: null
            });
            renderMessages();
        }, 2000);
    </script>
</body>
</html>
